{% extends "layout.html" %}
{% block content %}
    <div class="container-match">
        <form id="matchForm" method="POST" action="/match">
            <div class="row">
                <div class="col labels-column">
                    <div class="first-label">
                        <span class="info-label">PARAMETERS</span>
                    </div>
                    <div class="parameters-label">
                        <p class="labels-txt">CUISINE</p>
                        <p class="labels-txt">PRICE RANGE</p>
                        <p class="labels-txt">RATINGS</p>
                        <p class="labels-txt">DISTANCE</p>
                    </div>
                </div>
                <div class="col filters-column">
                    <div class="row filters-label-row">
                        <div class="col second-label">
                            <span class="filters-label">FILTERS</span>
                        </div>
                        <div class="col">
                            <span class="importance-label">IMPORTANCE</span>
                        </div>
                    </div>

                    <div class="row filters-params-row">
                        <div class="col d-flex flex-column align-items-center filters-params">
                            <select class="cuisine" name="cuisine">
                                {% if matchChoice['cuisine'] is not defined %}
                                    <option value="" selected>Wybierz kuchnię</option>
                                {% else %}
                                    <option value="">Wybierz kuchnię</option>
                                {% endif %}

                                {% for cuisine in cuisines %}
                                    {% if matchChoice['cuisine'] == cuisine['cuisine'] %}
                                    <option value="{{ cuisine['cuisine'] }}" selected>{{ cuisine['cuisine'] }}</option>
                                    {% else %}
                                    <option value="{{ cuisine['cuisine'] }}">{{ cuisine['cuisine'] }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>


                            <select class="price" name="price">
                                {% if matchChoice['price'] is not defined %}
                                    <option value="0" selected>Wybierz zakres cenowy</option>
                                {% else %}
                                    <option value="0">Wybierz zakres cenowy</option>
                                {% endif %}

                                {% if matchChoice['price'] == 20 %}
                                    <option value="20" selected>do 20</option>
                                {% else %}
                                    <option value="20">do 20</option>
                                {% endif %}

                                {% if matchChoice['price'] == 40 %}
                                    <option value="40" selected>do 40</option>
                                {% else %}
                                    <option value="40">do 40</option>
                                {% endif %}

                                {% if matchChoice['price'] == 60 %}
                                    <option value="60" selected>do 60</option>
                                {% else %}
                                    <option value="60">do 60</option>
                                {% endif %}

                                {% if matchChoice['price'] == 80 %}
                                    <option value="80" selected>do 80</option>
                                {% else %}
                                    <option value="80">do 80</option>
                                {% endif %}

                                {% if matchChoice['price'] == 100 %}
                                    <option value="100" selected>do 100</option>
                                {% else %}
                                    <option value="100">do 100</option>
                                {% endif %}

                                {% if matchChoice['price'] == 150 %}
                                    <option value="150" selected>do 150</option>
                                {% else %}
                                    <option value="150">do 150</option>
                                {% endif %}

                                {% if matchChoice['price'] == 200 %}
                                    <option value="200" selected>do 200</option>
                                {% else %}
                                    <option value="200">do 200</option>
                                {% endif %}

                                {% if matchChoice['price'] == 1000000 %}
                                <option value="1000000" selected>powyżej 200</option>
                                {% else %}
                                <option value="1000000">powyżej 200</option>
                                {% endif %}
 
                            </select>

                            <select class="ratings" name="ratings">
                                {% if matchChoice['ratings'] is not defined%}
                                    <option value="0" selected>Wybierz ocenę</option>
                                {% else %}
                                    <option value="0">Wybierz zakres cenow</option>
                                {% endif %}

                                {% if matchChoice['ratings'] == 1 %}
                                    <option value="1" selected>1</option>
                                {% else %}
                                    <option value="1">1</option>
                                {% endif %}

                                {% if matchChoice['ratings'] == 2 %}
                                    <option value="2" selected>2</option>
                                {% else %}
                                    <option value="2">2</option>
                                {% endif %}

                                {% if matchChoice['ratings'] == 3 %}
                                    <option value="3" selected>3</option>
                                {% else %}
                                    <option value="3">3</option>
                                {% endif %}

                                {% if matchChoice['ratings'] == 4 %}
                                    <option value="4" selected>4</option>
                                {% else %}
                                    <option value="4">4</option>
                                {% endif %}

                                {% if matchChoice['ratings'] == 5 %}
                                    <option value="5" selected>5</option>
                                {% else %}
                                    <option value="5">5</option>
                                {% endif %}
                            </select>

                            <select class="distance" name="distance">
                                {% if matchChoice['distance'] is not defined %}
                                    <option value="0" selected>Wybierz odległość</option>
                                {% else %}
                                    <option value="0">Wybierz odległość</option>
                                {% endif %}

                                {% if matchChoice['distance'] == 2 %}
                                    <option value="2" selected>do 2km</option>
                                {% else %}
                                    <option value="2">do 2km</option>
                                {% endif %}

                                {% if matchChoice['distance'] == 5 %}
                                    <option value="5" selected>do 5km</option>
                                {% else %}
                                    <option value="5">do 5km</option>
                                {% endif %}

                                {% if matchChoice['distance'] == 8 %}
                                    <option value="8" selected>do 8km</option>
                                {% else %}
                                    <option value="8">do 8km</option>
                                {% endif %}

                                {% if matchChoice['distance'] == 10 %}
                                    <option value="10" selected>do 10km</option>
                                {% else %}
                                    <option value="10">do 10km</option>
                                {% endif %}

                                {% if matchChoice['distance'] == 15 %}
                                    <option value="15" selected>do 15km</option>
                                {% else %}
                                    <option value="15">do 15km</option>
                                {% endif %}

                                {% if matchChoice['distance'] == 1000000 %}
                                <option value="1000000" selected>powyżej 15km</option>
                                {% else %}
                                <option value="1000000">powyżej 15km</option>
                                {% endif %}

                            </select>
                        </div>

                        <div class="col d-flex flex-column align-items-center weight-column">
                            <select class="cuisine-weight" name="cuisine_weight">
                                {% if matchChoice['cuisine_weight'] is not defined %}
                                    <option value="0" selected>0</option>
                                {% else %}
                                    <option value="0">0</option>
                                {% endif %}

                                {% if matchChoice['cuisine_weight'] == 1 %}
                                    <option value="1" selected>1</option>
                                {% else %}
                                    <option value="1">1</option>
                                {% endif %}

                                {% if matchChoice['cuisine_weight'] == 2 %}
                                    <option value="2" selected>2</option>
                                {% else %}
                                    <option value="2">2</option>
                                {% endif %}

                                {% if matchChoice['cuisine_weight'] == 3 %}
                                    <option value="3" selected>3</option>
                                {% else %}
                                    <option value="3">3</option>
                                {% endif %}

                                {% if matchChoice['cuisine_weight'] == 4 %}
                                    <option value="4" selected>4</option>
                                {% else %}
                                    <option value="4">4</option>
                                {% endif %}

                                {% if matchChoice['cuisine_weight'] == 5 %}
                                    <option value="5" selected>5</option>
                                {% else %}
                                    <option value="5">5</option>
                                {% endif %}
                            </select>

                            <select class="price-weight" name="price_weight">
                                {% if matchChoice['price_weight'] is not defined%}
                                    <option value="0" selected>0</option>
                                {% else %}
                                    <option value="0">0</option>
                                {% endif %}

                                {% if matchChoice['price_weight'] == 1 %}
                                    <option value="1" selected>1</option>
                                {% else %}
                                    <option value="1">1</option>
                                {% endif %}

                                {% if matchChoice['price_weight'] == 2 %}
                                    <option value="2" selected>2</option>
                                {% else %}
                                    <option value="2">2</option>
                                {% endif %}

                                {% if matchChoice['price_weight'] == 3 %}
                                    <option value="3" selected>3</option>
                                {% else %}
                                    <option value="3">3</option>
                                {% endif %}

                                {% if matchChoice['price_weight'] == 4 %}
                                    <option value="4" selected>4</option>
                                {% else %}
                                    <option value="4">4</option>
                                {% endif %}

                                {% if matchChoice['price_weight'] == 5 %}
                                    <option value="5" selected>5</option>
                                {% else %}
                                    <option value="5">5</option>
                                {% endif %}
                            </select>

                            <select class="ratings-weight" name="ratings_weight">
                                {% if matchChoice['ratings_weight'] is not defined %}
                                    <option value="0" selected>0</option>
                                {% else %}
                                    <option value="0">0</option>
                                {% endif %}

                                {% if matchChoice['ratings_weight'] == 1 %}
                                    <option value="1" selected>1</option>
                                {% else %}
                                    <option value="1">1</option>
                                {% endif %}

                                {% if matchChoice['ratings_weight'] == 2 %}
                                    <option value="2" selected>2</option>
                                {% else %}
                                    <option value="2">2</option>
                                {% endif %}

                                {% if matchChoice['ratings_weight'] == 3 %}
                                    <option value="3" selected>3</option>
                                {% else %}
                                    <option value="3">3</option>
                                {% endif %}

                                {% if matchChoice['ratings_weight'] == 4 %}
                                    <option value="4" selected>4</option>
                                {% else %}
                                    <option value="4">4</option>
                                {% endif %}

                                {% if matchChoice['ratings_weight'] == 5 %}
                                    <option value="5" selected>5</option>
                                {% else %}
                                    <option value="5">5</option>
                                {% endif %}
                            </select>

                            <select class="distance-weight" name="distance_weight">
                                {% if matchChoice['distance_weight'] is not defined%}
                                    <option value="0" selected>0</option>
                                {% else %}
                                    <option value="0">0</option>
                                {% endif %}

                                {% if matchChoice['distance_weight'] == 1 %}
                                    <option value="1" selected>1</option>
                                {% else %}
                                    <option value="1">1</option>
                                {% endif %}

                                {% if matchChoice['distance_weight'] == 2 %}
                                    <option value="2" selected>2</option>
                                {% else %}
                                    <option value="2">2</option>
                                {% endif %}

                                {% if matchChoice['distance_weight'] == 3 %}
                                    <option value="3" selected>3</option>
                                {% else %}
                                    <option value="3">3</option>
                                {% endif %}

                                {% if matchChoice['distance_weight'] == 4 %}
                                    <option value="4" selected>4</option>
                                {% else %}
                                    <option value="4">4</option>
                                {% endif %}

                                {% if matchChoice['distance_weight'] == 5 %}
                                    <option value="5" selected>5</option>
                                {% else %}
                                    <option value="5">5</option>
                                {% endif %}
                            </select>
                        </div>
                    </div>
                </div>

                <div class="col d-flex align-items-center justify-content-left save-column">
                    {% if current_user.is_authenticated %}
                    <div class="save-filters">
                        <button name="submitType" value="save" type="submit" class="btn btn-save">SAVE</button>
                    </div>
                    {% else %}
                    <div class="save-filters">
                        <a href="/login" class="btn btn-save">SAVE</a>
                    </div>
                    {% endif %}
                </div>
            </div>


            <div class="find-restaurant">
                <button type="submit" name="submitType" value="getLocation" class="btn btn-find">MATCH</button>
            </div>

            <!-- <div class="find-restaurant">
                <button id="showCarousel" onclick="getLocationAndFilters()" class="btn btn-find">MATCH</button>
            </div> -->
        </form>
        </div>

        {% if matchedRestaurants|length < 1 %}
            <span>Brak restauracji spełniającej kryteria</span>
        {% endif %}

        <div id="myCarousel" class="carousel slide karuzela" data-ride="carousel">
              <ol class="carousel-indicators">
                  {% for matchedRestaurants in matchedRestaurants %}
                  <li data-target="#myCarousel" data-slide-to="{{ loop.index }}" {% if loop.index == 1 %}class="active"{% endif %}></li>
                  {% endfor %}
              </ol>

              <div class="carousel-inner text-center">
                  {% for matchedRestaurants in matchedRestaurants %}
                  {% if loop.index == 1 %}
                    <div class="carousel-item active">
                      <img src="static/pictures/restaurant.png" alt="Obraz {{ loop.index }}">
                        <p>{{ matchedRestaurants['rest_name'] }}</p>
                        <button>Add to favoutives</button>
<!--                      <div class="carousel-caption">-->
<!--                        <h3>Opis 1</h3>-->
<!--                      </div>-->
                    </div>
                  {% else %}
                  <div class="carousel-item">
                      <img src="static/pictures/restaurant.png" alt="Obraz {{ loop.index }}">
                      <p>{{ matchedRestaurants['rest_name'] }}</p>
<!--                      <div class="carousel-caption">-->
<!--                        <h3>Opis 1</h3>-->
<!--                      </div>-->
                  </div>
                  {% endif %}
                  {% endfor %}
              </div>

            {% if matchedRestaurants|length > 0 %}
              <a class="carousel-control-prev" href="#myCarousel" role="button" data-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="sr-only">Poprzedni</span>
              </a>
              <a class="carousel-control-next" href="#myCarousel" role="button" data-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="sr-only">Następny</span>
              </a>
            {% endif %}
        </div>

        <script type="text/javascript">
            
            function getLocationAndFilters() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(sendPositionAndFilters);
            } else {
                console.log("Geolocation is not supported by this browser.");
            }
        }

        function sendPositionAndFilters(position) {
            var user_latitude = position.coords.latitude;
            var user_longitude = position.coords.longitude;

            // Get the selected filter values
            //var cuisine = document.getElementById('cuisine').value;
            //var price = document.getElementById('price').value;
            //var maxDistance = document.getElementById('maxDistance').value;

            var price = document.getElementsByClassName('price')[0];
            var price_w = document.getElementsByClassName('price-weight')[0];
            var val_price = price.options[price.selectedIndex].text;
            var val_price_w = price_w.options[price_w.selectedIndex].text;
            
            var ratings = document.getElementsByClassName('ratings')[0];
            var ratings_w = document.getElementsByClassName('ratings-weight')[0];
            var val_ratings = ratings.options[ratings.selectedIndex].text;
            var val_ratings_w = ratings_w.options[ratings_w.selectedIndex].text;

            var distance = document.getElementsByClassName('distance')[0];
            var distance_w = document.getElementsByClassName('distance-weight')[0];
            var val_distance = distance.options[distance.selectedIndex].text;
            var val_distance_w = distance_w.options[distance_w.selectedIndex].text;

            var cuisine = document.getElementsByClassName('cuisine')[0];
            var cuisine_w = document.getElementsByClassName('cuisine-weight')[0];
            var val_cuisine = cuisine.options[cuisine.selectedIndex].text;
            var val_cuisine_w = cuisine_w.options[cuisine_w.selectedIndex].text;

            alert("Price: " + val_price + ",w: " + val_price_w  + "\n" +
                          "ratings: " + val_ratings + ",w: " + val_ratings_w  + "\n" +
                          "distance: " + val_distance + ",w: " + val_distance_w  + "\n" +
                          "cuisine: " + val_cuisine + ",w: " + val_cuisine_w  +
                          "user_latitude: " + user_latitude + ",user_longitude " + user_longitude  
                    ); 

            //Send the location and filter data to your Flask application
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/process_match', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({
                'cuisine' : val_cuisine,
                'cuisene_w' : val_cuisine_w,
                'rating' : val_ratings,
                'rating_w' : val_ratings_w,
                'price' : val_price,
                'price_w' : val_price_w,
                'allowed_distance' : val_distance,
                'allowed_distance_w' : val_distance_w,
                'user_location_lat' : user_latitude, 
                'user_location_long' : user_longitude
            }));
        }
        </script>

        <script>
              $(document).ready(function() {
                  $('#matchForm').submit(function(event) {
                    event.preventDefault(); // Zapobieganie domyślnemu zachowaniu formularza

                    // Pobranie wybranych filtrów
                    var filters = [];
                    $('input[name="filter"]:checked').each(function() {
                      filters.push($(this).val());
                    });

                    // Pobranie lokalizacji użytkownika
                    if (navigator.geolocation) {
                      navigator.geolocation.getCurrentPosition(function(position) {
                        var latitude = position.coords.latitude;
                        var longitude = position.coords.longitude;

                        // Wysłanie danych do serwera za pomocą AJAX
                        $.ajax({
                          type: 'POST',
                          url: '/match',
                          data: {
                            filter: filters,
                            latitude: latitude,
                            longitude: longitude
                          },
                          success: function(response) {
                            // Obsługa odpowiedzi serwera
                            var results = response.results;
                            // Wyświetlenie karuzeli z wynikami
                            // Tutaj umieść kod do wyświetlenia karuzeli na stronie
                            $('#karuzela').html('Karuzela z wynikami');
                          },
                          error: function() {
                            alert('Wystąpił błąd podczas pobierania wyników.');
                          }
                        });
                      });
                    } else {
                      alert('Twoja przeglądarka nie obsługuje Geolocation API.');
                    }
                  });
                });
        </script>
    </div>
{% endblock content%}
